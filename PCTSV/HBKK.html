<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Xét Duyệt HB Khuyến Khích</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-light">
<div class="container-fluid pt-3">
    <a href="../TrangChu/index.html" class="btn btn-outline-secondary btn-sm mb-2">
        <i class="fas fa-arrow-left me-2"></i>Quay lại Trang chủ
    </a>
</div>
<div class="container-fluid py-4">
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-award me-2"></i>XÉT DUYỆT HỌC BỔNG KHUYẾN KHÍCH</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Học kỳ:</label>
                    <select class="form-select"><option>Học kỳ 2 (2024-2025)</option></select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Loại Học Bổng:</label>
                    <select id="cboLoaiHB" class="form-select">
                        <option value="">-- Tất cả --</option>
                        <option value="A">Loại A (Xuất sắc)</option>
                        <option value="B">Loại B (Giỏi)</option>
                    </select>
                </div>
               <div class="col-md-3">
                    <label class="form-label">Khoa:</label>
                    <select id="cboKhoa" class="form-select">
                        <option value="">-- Tất cả các Khoa --</option>
                        </select>
                </div>
               <button type="button" class="btn btn-warning w-100" onclick="fetchData()">
                <i class="fas fa-search me-2"></i>Quét hệ thống
            </button>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-4">
            <div class="alert alert-info d-flex justify-content-between align-items-center mb-0">
                <span><i class="fas fa-coins me-2"></i>Ngân sách Khoa:</span>
                <span class="fw-bold">50.000.000 VNĐ</span>
            </div>
        </div>
        <div class="col-md-4">
            <div class="alert alert-success d-flex justify-content-between align-items-center mb-0">
                <span><i class="fas fa-users me-2"></i>Chỉ tiêu suất:</span>
                <span class="fw-bold">15 Suất</span>
            </div>
        </div>
       <div class="col-md-4">
            <div class="alert alert-danger d-flex justify-content-between align-items-center mb-0">
                <span><i class="fas fa-check-circle me-2"></i>Đang chọn:</span>
                
                <span id="counter-text" class="fw-bold text-danger">0 / 15</span>
            </div>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <table class="table table-hover table-bordered mb-0 align-middle">
                <thead class="table-light">
                    <tr>
                        <th class="text-center" width="5%"><input type="checkbox" class="form-check-input"></th>
                        <th>MSSV</th>
                        <th>Họ Tên</th>
                        <th>Lớp</th>
                        <th class="text-center">GPA</th>
                        <th class="text-center">ĐRL</th>
                        <th class="text-center">Đ.HĐ</th>
                        <th class="text-center">Xếp hạng</th>
                        <th>Ghi chú (Hệ thống)</th>
                    </tr>
                </thead>
                
                <tbody id="table-body">
                    </tbody>

            </table>
        </div>
        <div class="card-footer d-flex justify-content-end gap-2">
            <button class="btn btn-secondary">Hủy bỏ</button>
            <button class="btn btn-primary"><i class="fas fa-save me-2"></i>Chốt danh sách & Lưu</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        loadDSKhoa(); 
    });
    // HÀM 1: LẤY DANH SÁCH KHOA TỪ SERVER
    async function loadDSKhoa() {
        try {
            let response = await fetch('http://localhost:3000/api/khoa');
            let data = await response.json();
            
            let cbo = document.getElementById('cboKhoa');
            
            data.forEach(khoa => {
                let option = document.createElement("option");
                option.value = khoa.MaKhoa; 
                option.text = khoa.TenKhoa; 
                cbo.appendChild(option);
            });
        } catch (error) {
            console.error("Lỗi tải khoa:", error);
        }
    }

    // HÀM 2: QUÉT HỆ THỐNG (Có lọc theo Khoa)
    async function fetchData() {
        console.log("--> Đã bấm nút Quét!"); 

        try {
            // 1. Lấy giá trị từ CẢ 2 ô chọn (Khoa và Loại HB)
            let cboKhoa = document.getElementById('cboKhoa');
            let maKhoa = cboKhoa ? cboKhoa.value : ""; 

            let cboLoai = document.getElementById('cboLoaiHB');
            let loaiHB = cboLoai ? cboLoai.value : ""; // <--- [MỚI] Lấy loại HB (A hoặc B)

            console.log(`Đang lọc: Khoa=[${maKhoa}], Loại=[${loaiHB}]`);

            // 2. Gọi API với đủ 2 tham số
            // Lưu ý: Dùng dấu & để nối các tham số
            let url = `http://localhost:3000/api/xetduyet-hbkk?maKhoa=${maKhoa}&loaiHB=${loaiHB}`;
            
            console.log("Đang gọi URL:", url);

            let response = await fetch(url);
            let data = await response.json();
            
            // 3. Phần hiển thị bảng (Giữ nguyên không đổi)
            let tbody = document.getElementById('table-body');
            tbody.innerHTML = ''; 

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Không tìm thấy sinh viên nào thỏa điều kiện</td></tr>';
                if(typeof updateCounter === "function") updateCounter();
                return;
            }

            data.forEach((sv, index) => {
                let isKyLuat = sv.GhiChuSystem && sv.GhiChuSystem.includes("Kỷ Luật");
                let rowClass = isKyLuat ? "table-secondary" : "";
                let badgeClass = isKyLuat ? "bg-danger" : "bg-success";
                let disabledCheck = isKyLuat ? "disabled" : "checked";

                let row = `
                    <tr class="${rowClass}">
                        <td class="text-center"><input type="checkbox" class="form-check-input student-checkbox" ${disabledCheck}></td>
                        <td>${sv.MaSV}</td>
                        <td>${sv.HoTen}</td>
                        <td>${sv.TenLop}</td>
                        <td class="text-center fw-bold text-primary">${sv.GPA}</td>
                        <td class="text-center">${sv.DiemRL}</td>
                        <td class="text-center">${sv.DiemHD}</td>
                        <td class="text-center">#${index + 1}</td>
                        <td><span class="badge ${badgeClass}">${sv.GhiChuSystem}</span></td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            // Cập nhật bộ đếm
            if(typeof updateCounter === "function") updateCounter();

        } catch (error) {
            console.error("Lỗi:", error);
            alert("Lỗi tải dữ liệu! Xem chi tiết trong Console (F12).");
        }
    }

    // 3. HÀM ĐẾM SỐ LƯỢNG ĐANG CHỌN
    function updateCounter() {
        let checkedBoxes = document.querySelectorAll('#table-body input[type="checkbox"]:checked');
        let count = checkedBoxes.length;
        let quota = 14; 

        let label = document.getElementById('counter-text');
        label.innerText = `${count} / ${quota}`;

        if (count > quota) {
            label.className = "fw-bold text-danger"; 
            label.innerText += " (Vượt quá!)";
        } else {
            label.className = "fw-bold text-success"; 
        }
    }
</script>

</body>
</html>